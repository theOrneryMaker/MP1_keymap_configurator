<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Macropad Keymap Configurator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #2d2d2d; color: #eee; }
        .layer { border: 1px solid #555; background: #3a3a3a; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .layer h2 { margin-top: 0; font-size: 1.4em; }
        .key_box {
            border: 1px solid #666;
            background: #444;
            padding: 12px;
            margin: 12px 0;
            border-radius: 6px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }
        .key_number { font-weight: bold; width: 80px; font-size: 1.1em; }
        .type_select { width: 170px; }
        .key_icon { width: 170px; }
        .single_line {
            width: 620px;
            height: 42px;
            padding: 10px 14px;
            font-family: 'Consolas', monospace;
            font-size: 15px;
            background: #1e1e1e;
            color: #a6e22e;
            border: 1px solid #555;
            border-radius: 6px;
            margin-top: 8px;
            flex-basis: 100%;
        }
        .single_line:focus {
            outline: none;
            border-color: #66d9ef;
            box-shadow: 0 0 8px rgba(102, 217, 239, 0.4);
        }
        .combo_keys {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .combo_keys select {
            width: 160px;
            padding: 8px;
            background: #333;
            color: #eee;
            border: 1px solid #666;
            border-radius: 4px;
        }
        .plus { font-weight: bold; font-size: 1.2em; color: #aaa; }
        .icon_row { display: flex; align-items: center; gap: 10px; }
        .icon_row label { width: 50px; }
        button { margin: 10px 5px 10px 0; padding: 10px; background: #0066cc; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0088ff; }
        #help_btn, #save_btn { background: #444; }
        #save_btn { background: #27ae60; }
        #save_btn:hover { background: #2ecc71; }
        #output { width: 100%; height: 400px; font-family: monospace; background: #222; color: #eee; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Macropad Keymap Configurator</h1>
    <input type="file" id="fileInput" accept=".json">
    <button onclick="loadKeymap()">Load Existing keymap.json</button>
    <button id="help_btn" onclick="toggleHelp()">Keymap Guide</button>
    <br><br>
    <label for="num_layers">Number of Layers:</label>
    <input type="number" id="num_layers" min="1" value="2" onchange="generateLayers()">
    <div id="layers_container"></div>
    
    <button onclick="generateKeymap()">Generate keymap.json</button>
    <button id="save_btn" onclick="saveKeymap()">Save keymap.json</button>
    <textarea id="output" rows="20" cols="80" placeholder="Click 'Generate keymap.json' to create the JSON, then 'Save keymap.json' to download the file."></textarea>

    <script>
        let defaultLayer = 1;
        let secretLayer = 0;

        const keyTypes = ['None', 'Website', 'App', 'String', 'Key Combo', 'Consumer Control', 'User Defined'];
        const consumerControls = ['PREV', 'PLAYPAUSE', 'NEXT', 'MUTE', 'VOL_DN', 'VOL_UP'];
        const keycodes = [
            'CONTROL', 'LEFT_CONTROL', 'RIGHT_CONTROL',
            'SHIFT', 'LEFT_SHIFT', 'RIGHT_SHIFT',
            'ALT', 'LEFT_ALT', 'RIGHT_ALT',
            'GUI', 'WINDOWS', 'COMMAND',
            'TAB', 'ENTER', 'BACKSPACE', 'DELETE', 'ESCAPE',
            'SPACE', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M',
            'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z',
            'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12',
            'LEFT_ARROW', 'RIGHT_ARROW', 'UP_ARROW', 'DOWN_ARROW',
            'KEYPAD_PLUS', 'KEYPAD_MINUS', 'KEYPAD_ENTER'
        ];

        function generateLayers() {
            const numLayers = Math.max(2, parseInt(document.getElementById('num_layers').value) || 2);
            const container = document.getElementById('layers_container');
            container.innerHTML = '';
            for (let l = 0; l < numLayers; l++) {
                const layerDiv = document.createElement('div');
                layerDiv.className = 'layer';
                layerDiv.innerHTML = `
                    <h2><input type="text" class="layer_name" maxlength="10" value="LAYER_${l}" style="font-size:1em; width:180px;"></h2>
                    <div class="checkboxes">
                        <label><input type="radio" name="default_layer" class="default_layer" value="${l}" ${l === 1 ? 'checked' : ''}> Default Layer</label>
                        <label><input type="radio" name="secret_layer" class="secret_layer" value="${l}" ${l === 0 ? 'checked' : ''}> Secret Layer</label>
                    </div>
                    <h3>KEYMAP (8 keys):</h3>
                    ${Array.from({length: 8}, (_, i) => `
                        <div class="key_box">
                            <span class="key_number">Key ${i}</span>
                            <select class="key_type_select" onchange="handleTypeChange(${l}, ${i})">
                                ${keyTypes.map(t => `<option value="${t}" ${t === 'None' ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                            <div class="icon_row" id="icon_row_${l}_${i}">
                                <label>Icon:</label>
                                <input type="text" class="key_icon" maxlength="4" value="---">
                            </div>
                            <div class="key_fields" id="key_fields_${l}_${i}"></div>
                        </div>
                    `).join('')}
                    <h3>Encoder Action:</h3>
                    <select class="encoder_type" onchange="toggleCustomEncoder(${l})">
                        <option value="None" selected>None</option>
                        <option value="Volume">Volume</option>
                        <option value="Zoom">Zoom</option>
                        <option value="Scroll">Scroll</option>
                        <option value="Custom">Custom</option>
                    </select>
                    <div class="custom_encoder" style="display:none; margin-top:8px;">
                        <input type="text" class="custom_encoder_action" placeholder="e.g. {&quot;mouse_wheel&quot;: 1}">
                    </div>
                `;
                container.appendChild(layerDiv);
            }
            for (let l = 0; l < numLayers; l++) {
                for (let k = 0; k < 8; k++) {
                    handleTypeChange(l, k);
                }
                toggleCustomEncoder(l);
            }
            attachRadioListeners();
        }

        function handleTypeChange(l, k) {
            const select = document.querySelectorAll('.key_type_select')[l * 8 + k];
            const iconRow = document.getElementById(`icon_row_${l}_${k}`);
            const iconInput = iconRow.querySelector('.key_icon');
            const fieldsDiv = document.getElementById(`key_fields_${l}_${k}`);
            const value = select.value;

            if (value === 'None') {
                iconRow.style.display = 'none';
                iconInput.value = '---';
                fieldsDiv.innerHTML = '';
            } else {
                iconRow.style.display = 'flex';
                if (iconInput.dataset.previousValue) iconInput.value = iconInput.dataset.previousValue;
                else if (iconInput.value === '---') iconInput.value = '';
                fieldsDiv.innerHTML = '';

                if (value === 'Website') {
                    fieldsDiv.innerHTML = `<input type="text" class="single_line" placeholder="https://example.com">`;
                } else if (value === 'App') {
                    fieldsDiv.innerHTML = `<input type="text" class="single_line" placeholder="C:\\Program Files\\App\\app.exe">`;
                } else if (value === 'String') {
                    fieldsDiv.innerHTML = `<input type="text" class="single_line" placeholder="Plain text to type">`;
                } else if (value === 'Key Combo') {
                    fieldsDiv.innerHTML = `
                        <div class="combo_keys">
                            <select><option value="">None</option>${keycodes.map(kc => `<option>${kc}</option>`).join('')}</select>
                            <span class="plus">+</span>
                            <select><option value="">None</option>${keycodes.map(kc => `<option>${kc}</option>`).join('')}</select>
                            <span class="plus">+</span>
                            <select><option value="">None</option>${keycodes.map(kc => `<option>${kc}</option>`).join('')}</select>
                        </div>`;
                } else if (value === 'Consumer Control') {
                    fieldsDiv.innerHTML = `<select class="single_line">${consumerControls.map(cc => `<option>${cc}</option>`).join('')}</select>`;
                } else if (value === 'User Defined') {
                    fieldsDiv.innerHTML = `<input type="text" class="single_line" placeholder="e.g. Keycode.TAB or &quot;hello&quot; or (Keycode.CONTROL, Keycode.C)">`;
                }
            }

            if (value !== 'None' && iconInput.value !== '---') {
                iconInput.dataset.previousValue = iconInput.value;
            }
        }

        function toggleCustomEncoder(l) {
            const select = document.querySelectorAll('.encoder_type')[l];
            const customDiv = document.querySelectorAll('.custom_encoder')[l];
            customDiv.style.display = select.value === 'Custom' ? 'block' : 'none';
        }

        function attachRadioListeners() {
            document.querySelectorAll('.default_layer').forEach(r => r.addEventListener('change', function() {
                if (this.checked) {
                    defaultLayer = parseInt(this.value);
                    if (defaultLayer === secretLayer) { this.checked = false; alert("Cannot be both Default and Secret."); }
                }
            }));
            document.querySelectorAll('.secret_layer').forEach(r => r.addEventListener('change', function() {
                if (this.checked) {
                    secretLayer = parseInt(this.value);
                    if (secretLayer === defaultLayer) { this.checked = false; alert("Cannot be both Default and Secret."); }
                }
            }));
        }

        function loadKeymap() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('Select a file');
            const reader = new FileReader();
            reader.onload = e => {
                try { parseJsonKeymap(JSON.parse(e.target.result)); }
                catch (err) { alert('Invalid JSON: ' + err); }
            };
            reader.readAsText(file);
        }

        function parseJsonKeymap(data) {
            const numLayers = data.layer_names.length;
            document.getElementById('num_layers').value = numLayers;
            generateLayers();

            setTimeout(() => {
                document.querySelectorAll('.layer_name').forEach((el, i) => el.value = data.layer_names[i] || '');

                defaultLayer = data.default_layer ?? 1;
                secretLayer = data.secret_layer ?? 0;
                document.querySelectorAll('.default_layer').forEach(r => r.checked = parseInt(r.value) === defaultLayer);
                document.querySelectorAll('.secret_layer').forEach(r => r.checked = parseInt(r.value) === secretLayer);

                data.keymap.forEach((layer, l) => {
                    layer.forEach((action, k) => {
                        const select = document.querySelectorAll('.key_type_select')[l * 8 + k];
                        const iconInput = document.querySelectorAll('.key_icon')[l * 8 + k];

                        if (action === null) {
                            select.value = 'None';
                            iconInput.value = '---';
                        } else {
                            if (typeof action === 'string' && (action.startsWith('http') || action.startsWith('win:'))) {
                                select.value = action.startsWith('http') ? 'Website' : 'App';
                            } else if (typeof action === 'string' && !consumerControls.includes(action) && !keycodes.includes(action)) {
                                select.value = 'String';
                            } else if (consumerControls.includes(action)) {
                                select.value = 'Consumer Control';
                            } else if (Array.isArray(action)) {
                                select.value = 'Key Combo';
                            } else {
                                select.value = 'User Defined';
                            }
                            if (data.icons?.[l]?.[k]) {
                                iconInput.value = data.icons[l][k];
                                iconInput.dataset.previousValue = data.icons[l][k];
                            }
                        }
                        handleTypeChange(l, k);

                        if (action !== null) {
                            const field = document.getElementById(`key_fields_${l}_${k}`).firstElementChild;
                            if (!field) return;

                            if (select.value === 'Website' || select.value === 'App' || select.value === 'String') {
                                field.value = typeof action === 'string' ? action : '';
                            } else if (select.value === 'Consumer Control') {
                                field.value = action;
                            } else if (select.value === 'Key Combo') {
                                const selects = field.querySelectorAll('select');
                                action.forEach((key, i) => { if (selects[i]) selects[i].value = key; });
                            } else if (select.value === 'User Defined') {
                                let code = '';
                                if (typeof action === 'string') {
                                    if (action.startsWith('http') || action.startsWith('win:')) code = `"${action}"`;
                                    else if (consumerControls.includes(action)) code = `ConsumerControlCode.${action}`;
                                    else if (keycodes.includes(action)) code = `Keycode.${action}`;
                                    else code = `"${action}"`;
                                } else if (Array.isArray(action)) {
                                    code = `(${action.map(k => `Keycode.${k}`).join(', ')})`;
                                }
                                field.value = code;
                            }
                        }
                    });
                });

                if (data.encoder_actions) {
                    data.encoder_actions.forEach((enc, l) => {
                        const select = document.querySelectorAll('.encoder_type')[l];
                        const custom = document.querySelectorAll('.custom_encoder_action')[l];
                        if (!enc) select.value = 'None';
                        else if (enc.cc) select.value = 'Volume';
                        else if (enc.mouse_wheel) select.value = 'Scroll';
                        else if (enc.combo) select.value = 'Zoom';
                        else { select.value = 'Custom'; custom.value = JSON.stringify(enc, null, 2); }
                        toggleCustomEncoder(l);
                    });
                }
            }, 100);
        }

        function generateKeymap() {
            const numLayers = parseInt(document.getElementById('num_layers').value) || 2;

            const layer_names = [];
            const icons = [];
            const keymap = [];
            const encoder_actions = [];
            const encoder_icons = [];

            for (let l = 0; l < numLayers; l++) {
                layer_names.push(document.querySelectorAll('.layer_name')[l].value.trim() || `LAYER_${l}`);

                const layerIcons = [];
                const layerKeys = [];

                for (let k = 0; k < 8; k++) {
                    const typeSelect = document.querySelectorAll('.key_type_select')[l * 8 + k];
                    const type = typeSelect.value;

                    const iconInput = document.querySelectorAll('.key_icon')[l * 8 + k];
                    let icon = (iconInput.value || '').trim().toUpperCase();
                    if (type === 'None') icon = '---';
                    else icon = (icon + '----').slice(0, 4);
                    layerIcons.push(icon);

                    if (type === 'None') {
                        layerKeys.push(null);
                        continue;
                    }

                    const field = document.getElementById(`key_fields_${l}_${k}`).firstElementChild;
                    let action = null;

                    if (type === 'Website' || type === 'App' || type === 'String') {
                        action = field.value.trim() || null;
                        if (type === 'App' && action && !action.startsWith('win:')) action = 'win:' + action;
                    } else if (type === 'Consumer Control') {
                        action = field.value;
                    } else if (type === 'Key Combo') {
                        const vals = Array.from(field.querySelectorAll('select')).map(s => s.value).filter(v => v);
                        action = vals.length ? vals : null;
                    } else if (type === 'User Defined') {
                        const code = field.value.trim();
                        if (!code || code === 'None') action = null;
                        else if (code.startsWith('"') && code.endsWith('"')) action = code.slice(1, -1);
                        else if (code.startsWith('Keycode.')) action = code.replace('Keycode.', '').trim();
                        else if (code.startsWith('ConsumerControlCode.')) action = code.replace('ConsumerControlCode.', '').trim();
                        else if (code.startsWith('(') && code.endsWith(')')) {
                            action = code.slice(1, -1).split(',').map(s => s.trim()).filter(s => s.startsWith('Keycode.')).map(s => s.replace('Keycode.', '').trim());
                            action = action.length ? action : null;
                        } else action = code;
                    }

                    layerKeys.push(action);
                }

                icons.push(layerIcons);
                keymap.push(layerKeys);

                const encSelect = document.querySelectorAll('.encoder_type')[l];
                const customInput = document.querySelectorAll('.custom_encoder_action')[l];
                let enc = null;
                let enc_icon = '----';

                switch (encSelect.value) {
                    case 'Volume':   enc = { "cc": "VOL_UP" }; enc_icon = 'VOL'; break;
                    case 'Scroll':   enc = { "mouse_wheel": 1 }; enc_icon = 'SCRL'; break;
                    case 'Zoom':     enc = { "combo": ["CONTROL", "KEYPAD_PLUS"], "combo_ccw": ["CONTROL", "KEYPAD_MINUS"] }; enc_icon = 'ZOOM'; break;
                    case 'Custom':   if (customInput.value.trim()) try { enc = JSON.parse(customInput.value.trim()); } catch(e){}; enc_icon = '----'; break;
                    default:         enc = null; enc_icon = '----';
                }
                encoder_actions.push(enc);
                encoder_icons.push(enc_icon);
            }

            const jsonOutput = { layer_names, secret_layer: secretLayer, default_layer: defaultLayer, keymap, icons, encoder_icons, encoder_actions };
            let output = JSON.stringify(jsonOutput, null, 2);
            output = output.replace(/ {4}/g, '  ')
                           .replace(/default_layer": 1,/g, 'default_layer": 1,\n\n')
                           .replace(/\],\n  "icons"/g, '],\n\n  "icons"')
                           .replace(/\],\n  "encoder_icons"/g, '],\n\n  "encoder_icons"')
                           .replace(/\],\n  "encoder_actions"/g, '],\n\n  "encoder_actions"');

            document.getElementById('output').value = output;
        }

        function saveKeymap() {
            const text = document.getElementById('output').value.trim();
            if (!text) return alert('Generate first!');
            const blob = new Blob([text], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `keymap_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        generateLayers();
    </script>
</body>
</html>